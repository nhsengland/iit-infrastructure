---
# This playbook sets installs the CKAN application.
- name: update apt-cache
  become: true
  apt: update_cache=yes

- name: install packages for CKAN
  apt: pkg={{ item }} state=installed
  with_items:
    - nginx
    - libpq5
    - emacs
    - git
    - htop
    - iotop
    - tree
    - ack-grep
    - vim
    - zip
    - screen
    - python-boto
    - python-virtualenv
    - libmemcached-dev
    - memcached
    - python-dev
    - build-essential

# TODO: swap the following (except the pylibmc block) out for the old deb
# install when CKAN release a 16.04 compatible version.

- name: create CKAN lib directory
  become: true
  file:
    path: /usr/lib/ckan/default
    state: directory
    mode: 0755

- name: create CKAN etc directory
  become: true
  file:
    path: /etc/ckan/default
    state: directory
    mode: 0755

- name: create CKAN virtualenv
  become: true
  command: virtualenv /usr/lib/ckan/default

- name: install CKAN from git repository
  become: true
  pip:
    editable: true
    name: git+https://github.com/ckan/ckan.git@ckan-2.2.4#egg=ckan
    virtualenv: /usr/lib/ckan/default

- name: install CKAN python requirements
  become: true
  pip:
    requirements: /usr/lib/ckan/default/src/ckan/requirements.txt
    virtualenv: /usr/lib/ckan/default

- name: Add WSGI file
  template:
    src: config/apache.wsgi
    dest: /etc/ckan/default/apache.wsgi

- name: link who.ini
  file:
    src: /usr/lib/ckan/default/src/ckan/who.ini
    dest: /etc/ckan/default/who.ini
    state: link

- name: install pylibmc
  become: true
  pip:
    name: pylibmc
    virtualenv: /usr/lib/ckan/default
