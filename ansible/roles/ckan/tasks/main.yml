---
# This playbook sets installs the CKAN application.

# TODO: swap the following (except the pylibmc block) out for the old deb
# install when CKAN release a 16.04 compatible version.

- name: create CKAN lib directory
  become: true
  file:
    path: /usr/lib/ckan/default
    state: directory
    mode: 0755
    owner: ubuntu

- name: create CKAN etc directory
  become: true
  file:
    path: /etc/ckan/default
    state: directory
    mode: 0755

- name: create CKAN virtualenv
  become: true
  become_user: ubuntu
  command: virtualenv /usr/lib/ckan/default

- name: install an older setuptools for CKAN
  become: true
  become_user: ubuntu
  pip:
    name: setuptools
    version: 36.1
    virtualenv: /usr/lib/ckan/default

- name: install CKAN from git repository
  become: true
  become_user: ubuntu
  pip:
    editable: true
    name: git+https://github.com/ckan/ckan.git@ckan-2.2.4#egg=ckan
    virtualenv: /usr/lib/ckan/default

- name: install CKAN python requirements
  become: true
  become_user: ubuntu
  pip:
    requirements: /usr/lib/ckan/default/src/ckan/requirements.txt
    virtualenv: /usr/lib/ckan/default

- name: Add WSGI file
  template:
    src: config/apache.wsgi
    dest: /etc/ckan/default/apache.wsgi

- name: link who.ini
  file:
    src: /usr/lib/ckan/default/src/ckan/who.ini
    dest: /etc/ckan/default/who.ini
    state: link

- name: install pylibmc
  become: true
  become_user: ubuntu
  pip:
    name: pylibmc
    virtualenv: /usr/lib/ckan/default

- name: remove existing Solr schema.xml
  file:
    path: /etc/solr/conf/schema.xml
    state: absent

- name: link SOLR schema.xml from Ckan
  file:
    src: /usr/lib/ckan/default/src/ckan/ckan/config/solr/schema.xml
    dest: /etc/solr/conf/schema.xml
    state: link
  notify: Restart Jetty
